<!DOCTYPE html>
<html lang="en">
<head>
  <title>Best @ Times Square</title>
  <link rel="Shortcut Icon" type="image/x-icon" href="data/favicon.ico" />
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js" ></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.10.2/jquery-ui.min.js"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/d3/2.10.0/d3.v2.min.js"></script>
  <!-- <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?sensor=false"></script> -->
  <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDWx_-7PwHUJsp3sj0iT-SK8w_HTojODok&sensor=false&callback=initMap"></script>
  <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.9.0/themes/blitzer/jquery-ui.css" type="text/css">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
  <!-- <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script> -->
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
  <script src="https://d3js.org/d3.v4.min.js"></script>

  <script src="data/hotel.geojson"></script>
  <script src="data/food.geojson"></script>
</head>
<body>
<nav class="navbar navbar-inverse navbar-fixed-top">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#myNavbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>                        
      </button>
      <a class="navbar-brand" href="#">Best @ Times Square</a>
    </div>
    <div class="collapse navbar-collapse" id="myNavbar">
      <ul class="nav navbar-nav">
        <li><a href="#home">Home</a></li>
        <li><a href="#about-us">About US</a></li>
        <li><a href="https://github.com/pinhao1994/best-at-times-square/blob/master/Best%20At%20Times%20Square_Final%20Report.Rmd">Report</a></li>
        <li class="active dropdown">
          <a class="dropdown-toggle" data-toggle="dropdown" href="#">
            Category: <font id="chosen_cat" style="color: red"><i>None</i></font>
            <span class="caret"></span>
          </a>
          <ul id="category_options" class="dropdown-menu">  
            <li><a href="#home">None</a></li>
            <li><a href="#home">Asian</a></li>
            <li><a href="#home">Europe</a></li>
            <li><a href="#home">Mid East</a></li>
            <li><a href="#home">North American</a></li>
            <li><a href="#home">South American</a></li>
            <li><a href="#home">Steakhouse</a></li>
            <li><a href="#home">Pizza</a></li>
            <li><a href="#home">Coffee</a></li>
            <li><a href="#home">Deli</a></li>
            <li><a href="#home">Other</a></li>
          </ul>
        </li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li><a id="initial" href="#" data-toggle="modal" data-target="#myModal"><span class="glyphicon glyphicon-search"></span> Instruction</a></li>
      </ul>
    </div>
  </div>
</nav>

<header id="home" class="container-fluid" style="background-color:#fafafa;">
  <div class="row">
    <div id=map class="col-xs-7 col-md-8"></div>
    <div id="quake-pop-up", class="col-xs-12 col-sm-4">
      <div id="quake-pop-up-title" class="col-xs-12"></div>
        <div id="quake-pop-up-content">
          <div id="quake-pop-desc" class="col-xs-12"></div>
          <div id="quake-pop-hist" class="col-xs-12"></div>
        </table>
      </div>
    </div>
  </div>
</header>

<section id="about-us" class="container-fluid" style="background-color:#DBEDF3;">
  <div class="col-md-6">
    <person class="row">
      <div class="col-xs-4">
        <img src="data/Bill.jpg" class="img-circle" alt="Bill" width="200" height="200">
      </div>
      <div class="col-xs-8">
        <h1>Pin-Hao (Bill) Chen</h1>
        <h4>phc2121 | Data Scientist & Web Engineer</h4>
        <form action="https://www.linkedin.com/in/pinhao-chen-19940514/">
          <input type="submit" class="btn btn-info" value="LinkedIn">
        </form>
      </div>
    </person>
    <person class="row">
      <div class="col-xs-4">
        <img src="data/youyang.jpg" class="img-circle" alt="youyang" width="200" height="200">
      </div>
      <div class="col-xs-8">
        <h1>Youyang Liu</h1>
        <h4>yl3767 | Data Scientist</h4>
        <form action="https://www.linkedin.com/in/youyangliu/">
          <input type="submit" class="btn btn-info" value="LinkedIn">
        </form>
      </div>
    </person>
  </div>
  <div class="col-md-6">
    <person class="row">
      <div class="col-xs-4">
        <img src="data/Anna.png" class="img-circle" alt="Anna" width="200" height="200">
      </div>
      <div class="col-xs-8">
        <h1>Anna Zhou</h1>
        <h4>yz3220 | Data Scientist & Designer</h4>
        <form action="https://www.linkedin.com/in/yang-anna-zhou/">
          <input type="submit" class="btn btn-info" value="LinkedIn" />
        </form>
      </div>      
    </person>
    <person class="row">
      <div class="col-xs-4">
        <img src="data/Jolie.jpg" class="img-circle" alt="Jolie" width="200" height="200">
      </div>
      <div class="col-xs-8">
        <h1>Jolie Tan</h1>
        <h4>jt2998 | Data Scientist</h4>
        <form action="https://www.linkedin.com/in/jolietan/">
          <input type="submit" class="btn btn-info" value="LinkedIn" />
        </form>
      </div>
    </person>
  </div>
</section>

<footer class="container-fluid">
  <div class="row">
    <div class="col-xs-12 text-center">
      <p>Copyright <strong>Â© <script type="text/javascript">document.write(new Date().getFullYear());</script> Pin-Hao Chen | Anna Zhou</strong> ALL RIGHTS RESERVED</p>
    </div>
  </div>
</footer>

<!-- Modal -->
<div id="myModal" class="modal fade" role="dialog">
  <div class="modal-dialog">
    <!-- Modal content-->
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">&times;</button>
        <h4 class="modal-title">Instruction</h4>
      </div>
      <div class="modal-body">
        <section class="row">
          <div class="col-xs-3">
            <img src="data/blue.png" class="img-thumbnail" alt="blueCircle-Hotel" height="100" width="130">
          </div>
          <div class="col-xs-3">
            Each <font style="color: blue"><i>blue</i></font> point represents a <b>HOTEL</b>
          </div>
          <div class="col-xs-3">
            <img src="data/green.png" class="img-thumbnail" alt="greenCircle-Restaurant" height="100" width="130">
          </div>
          <div class="col-xs-3">
            Each <font style="color: green"><i>green</i></font> point represents a <b>RESTAURANT</b>
          </div>
        </section>
        <section class="row">
          <div class="col-xs-6">
            <img src="data/restaurants.png" class="img-thumbnail" alt="restaurant-detail" height="150" width="320"> 
          </div>
          <div class="col-xs-6">
            Mouse over <font style="color: green"><i>GREEN</i></font> points, a gray box will pop up showing the details of the current restaurant, including yelp rating, price and review counts.
          </div>
        </section>
        <section class="row">
          <div class="col-xs-6">        
            <img src="data/hotel.png" class="img-thumbnail" alt="hotel-detail" height="350" width="320">
          </div>
          <div class="col-xs-6">
            Mouse over <font style="color: blue"><i>BLUE</i></font> points, a gray box will pop up showing the details of the current hotel, including yelp rating, price and review counts.
            <br><br>
            A <b>histogram</b> of top 5 restaurant categories with highest counts around current hotel will also be displayed.
          </div>
        </section>
        <section class="row">
          <div class="col-xs-6">
            <img src="data/topRes.png" class="img-thumbnail" alt="topRestaurant" height="350" width="350">
          </div>
          <div class="col-xs-6">
            <div class="row">
              The <font style="color: blue"><i>blue</i></font> point is clickable. If you click on it, a blue circle representing the area within 100 meter radius of the hotel will show up.
              <br><br>
              The gray information box also will list out the top 3 (calculated based on rating and review count) restaurants within the circled area, and their representing points on the map will be colored <font style="color: #F9CE00"><i>yellow</i></font>.
            </div>
            <div class="row">
              <img src="data/circle.png" class="img-thumbnail" alt="hotel-circle" height="130" width="150">
            </div>
          </div>
        </section>
        <section class="row">
          <div class="col-xs-12">
            <img src="data/nav_cat.png" class="img-thumbnail" alt="navbar-category">
          </div>
          <div class="col-xs-12">
            <div class="col-xs-4">
              <img src="data/red.png" class="img-thumbnail" alt="redCircle-Restaurant">
            </div>
            <div class="col-xs-8">
              By clicking the <b>Category</b> option on navigation bar, you can choose the specific category restaurants. The chosen restaurant will show in color <font style="color: red">red</font>. 
            </div>

          </div>
        </section>
        <section class="row">
          <div class="col-xs-12">
            <img src="data/instructionbar.png" class="img-thumbnail" alt="instruction-bar">
          </div>
          <div class="col-xs-12">
            <center><h5>To see the <b><i>Instruction</i></b> again, please click the button at the <b>right top</b> corner.</h5></center>
          </div>
        </section>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
</body>
<script>
$("#initial").click();
$("#quake-pop-up").draggable();
$('#category_options li a').on("click", function(){
  $("#chosen_cat i").text($(this).text());
  var chosen_class = $(this).text().replace(" ", "_");
  //console.log(chosen_class);
  $('.food').css("fill", "green");
  $(`.${chosen_class}`).css("fill", "red").effect(  "bounce" );
});

$(function () {

  //http://bl.ocks.org/mbertrand/34abee79acba54251801
  var $map = $("#map");
  var map = new google.maps.Map($map[0], {
    zoom: 16.5,
    clickableIcons: false,
    center: new google.maps.LatLng(40.759,-73.985),
    mapTypeId: google.maps.MapTypeId.TERRAIN    
  });
  var customStyled = [
    { featureType: "administrative", elementType: "labels", stylers: [{ visibility: "off" }]},
    { featureType: "poi", elementType: "labels", stylers: [{ visibility: "off" }]},
    { featureType: "water", elementType: "labels", stylers: [{ visibility: "of" }]},
    { featureType: "road", elementType: "labels", stylers: [{ visibility: "on" }]}
  ];
  map.set('styles',customStyled);
  var marker = new google.maps.Marker({
    position: new google.maps.LatLng(40.7588,-73.985),
    map: map,
    title: 'Times Square',
    animation: google.maps.Animation.DROP,
    icon: {
      url: 'https://image.flaticon.com/icons/svg/252/252025.svg',
      scaledSize: new google.maps.Size(50, 50),
      origin: new google.maps.Point(0, 0),
      anchor: new google.maps.Point(32,65),
      labelOrigin: new google.maps.Point(28,12)
    },
    label: {
      text: 'Times Square',
      //color: "#eb3a44",
      fontSize: "16px",
      fontWeight: "bold",
    },
  });

  var overlay = new google.maps.OverlayView();

  overlay.onAdd = function () {
    var layer = d3.select(this.getPanes().overlayMouseTarget).append("div").attr("class", "SvgOverlay");
    var svg = layer.append("svg");
    var my_pt = svg.append("g").attr("class", "my_pt");

    overlay.draw = function () {
      var clicked_hotel_id = "", marked_food_id = [];
      var markerOverlay = this;
      var overlayProjection = markerOverlay.getProjection();

      // Turn the overlay projection into a d3 projection
      var googleMapProjection = function (coordinates) {
          var googleCoordinates = new google.maps.LatLng(coordinates[1], coordinates[0]);
          var pixelCoordinates = overlayProjection.fromLatLngToDivPixel(googleCoordinates);
          return [pixelCoordinates.x + 4000, pixelCoordinates.y + 4000];
      }

      path = d3.geo.path().projection(googleMapProjection);
      
      // clean the old paths when zooming the map 
      d3.selectAll("path").remove(); 

      my_pt.selectAll("dummy_path") // Food
        .data(food_json.features) 
        .enter().append("svg:path")
        .attr("d", path.pointRadius(Math.sqrt((Math.exp(parseFloat(3.5))))))
        .attr("center", path.pointRadius(Math.sqrt((Math.exp(parseFloat(3.5))))))
        .attr("class", d => `food ${(d.properties.Category2ndLevel).replace(" ", "_")}`)
        .attr("id", d => d.properties.ID)
        .on("mouseover", function (d) {
          //var mousePosition = d3.svg.mouse(this);
          $("#quake-pop-up").fadeOut(100, function () {
            // Popup content
            $("#quake-pop-up-title").html(d.properties.CompanyName);
            $("#quake-pop-desc").html(`
              Category: ${d.properties.YelpCategory}<br/>
              Address: ${d.properties.Address}<br/>
              Phone: ${formatPhoneNumber(d.properties.Phone)}<br/>
              Yelp Rating: ${d.properties.Rating}<br/>
              Yelp Review Count: ${d.properties.Review}<br/>
              Yelp Price: ${formatPrice(d.properties.Price)}<br/>
              `
            );
            d3.select("#quake-pop-hist svg").remove();
            $("#quake-pop-up").fadeIn(100);
          });
        })
        .on("mouseout", function () {
          d3.select("#quake-pop-hist svg").remove();
          $("#quake-pop-up").fadeOut(50);
        });

      my_pt.selectAll("dummy_path") //  Hotel
        .data(hotel_json.features) 
        .enter().append("svg:path")
        .attr("d", path.pointRadius(Math.sqrt((Math.exp(parseFloat(4))))))
        .attr("center", path.pointRadius(Math.sqrt((Math.exp(parseFloat(4))))))
        .attr("class","hotel") 
        .attr("id", function(d){return d.properties.ID;})                  
        .on("mouseover", function (d) {
          d3.select(this).style("fill-opacity", 0.4);
          if(d3.select(this).attr("d")!= d3.select(this).attr("center")){
            $("#quake-pop-up").fadeOut(100, function () {
              $("#quake-pop-up-title").html("Top Restaurants Near "+d.properties.CompanyName);
              marked_food_id = (d.properties.top3restaurant).split("|");
              $("#quake-pop-desc").html(function(){
                var html_str = ""
                for(i in marked_food_id){
                  //console.log(marked_food_id[i]);
                  food_d = d3.select(`#${marked_food_id[i]}`).data()[0];
                  html_str += `
                    === ${food_d.properties.CompanyName} === <br/>
                    Category: ${food_d.properties.YelpCategory}<br/>
                    Address: ${food_d.properties.Address}<br/>
                    Phone: ${formatPhoneNumber(food_d.properties.Phone)}<br/>
                    Yelp Rating: ${food_d.properties.Rating}<br/>
                    Yelp Review Count: ${food_d.properties.Review}<br/>
                    Yelp Price: ${formatPrice(food_d.properties.Price)}<br/><br/>
                  `
                }
                return html_str
              });
              d3.select("#quake-pop-hist svg").remove();
              $("#quake-pop-up").fadeIn(100);
            });
          }
          else {
            //var mousePosition = d3.svg.mouse(this);
            $("#quake-pop-up").fadeOut(100, function () {
              // Popup content
              $("#quake-pop-up-title").html(d.properties.CompanyName);
              var price = "NA";
              if(d.properties.Price!="NA")
                price = Array(parseInt(d.properties.Price)+1).join("$");

              $("#quake-pop-desc").html(
                "Address: "+d.properties.Address+"<br/>"+
                "Phone: "+formatPhoneNumber(d.properties.Phone)+"<br/>"+
                "Yelp Rating: "+d.properties.Rating+"<br/>"+
                "Yelp Review Count: "+d.properties.Review+"<br/>"+
                "Yelp Price: "+price+"<br/>"
              );
              $("#quake-pop-hist").html(function(){
                var pairs = d.properties.top5cat.split("|")
                var cat = [], bardata = [];

                for(i in pairs){
                  tmp = pairs[i].split(":");
                  cat.push(tmp[0]);
                  if(tmp.length == 1) 
                    bardata.push(0);
                  else
                    bardata.push(tmp[1]);
                }
                createHistogram(cat, bardata);
              });
              
              $("#quake-pop-up").fadeIn(100);
            });
          }
        })
        .on("mouseout", function () {
          $("#quake-pop-up").fadeOut(50);
          d3.select("#quake-pop-hist svg").remove();
          if("#"+d3.select(this).attr("id") == clicked_hotel_id)
            d3.select(this).style("fill-opacity", 0.2);
          else
            d3.select(this).style("fill-opacity", 0.6);
        })
        .on("click", function(d) {
          if (clicked_hotel_id != "") {
            var clicked_pt = d3.selectAll(clicked_hotel_id)
            clicked_pt
              .attr("d",  clicked_pt.attr("center"))
              .style("fill-opacity", 0.5);
            $("#"+marked_food_id.join(", #")).css({"fill": "green", "fill-opacity": 0.2});
          }
          clicked_hotel_id = "#"+d.properties.ID;
          marked_food_id = (d.properties.top3restaurant).split("|");
          $("#"+marked_food_id.join(", #")).css({"fill": "#F9CE00", "fill-opacity": 1});

          d3.select("#"+d.properties.ID)
            .transition().duration(1000)
            .attr("d", path.pointRadius(function (d) {
              lat = d.properties.Latitude;
              zoom = map.getZoom();
              metersPerPx = 156543.03392 * Math.cos(lat * Math.PI / 180) / Math.pow(2, zoom)
              return (100/metersPerPx); 
            }))
            .style("fill-opacity", 0.2);

          $("#quake-pop-up").fadeOut(100, function () {
            // Popup content
            $("#quake-pop-up-title").html(`Top Restaurants Near ${d.properties.CompanyName}`);
            $("#quake-pop-desc").html(function(){
              //marked_food_id.join(" | ")
              var html_str = ""
              for(i in marked_food_id){
                //console.log(marked_food_id[i]);
                food_d = d3.select(`#${marked_food_id[i]}`).data()[0];
                html_str += `
                  === ${food_d.properties.CompanyName} === <br/>
                  Category: ${food_d.properties.YelpCategory}<br/>
                  Address: ${food_d.properties.Address}<br/>
                  Phone: ${formatPhoneNumber(food_d.properties.Phone)}<br/>
                  Yelp Rating: ${food_d.properties.Rating}<br/>
                  Yelp Review Count: ${food_d.properties.Review}<br/>
                  Yelp Price: ${formatPrice(food_d.properties.Price)}<br/><br/>
                `
              }
              return html_str
            });
            d3.select("#quake-pop-hist svg").remove();
            $("#quake-pop-up").fadeIn(100);
          });
        });
      };
};
overlay.setMap(map);

function formatPhoneNumber(s) {
  var s2 = (""+s).replace(/\D/g, '');
  var m = s2.match(/^(\d{3})(\d{3})(\d{4})$/);
  return (!m) ? null : "(" + m[1] + ") " + m[2] + "-" + m[3];
}

function formatPrice(p) {
  var price = "NA";
  if(p != "NA")
    price = Array(parseInt(p)+1).join("$");
  return price
}

function createHistogram(cat, bardata){
  d3.select("#quake-pop-hist svg").remove();
  var w = 400;
  var h = 300;
  var margin = {top: 25, right: 25, bottom: 25, left: 25};
  var innerWidth = w - margin.left - margin.right;
  var innerHeight = h - margin.top - margin.bottom;
  var svg = d3.select("#quake-pop-hist")
      .append("svg")
      .attr("width", w)
      .attr("height", h);

  var xScale = d3.scaleBand()
      .domain(d3.range(cat.length))
      .range([0, innerWidth])
      .paddingInner(.3);

  var yScale = d3.scaleLinear()
      .domain([0, d3.max(bardata)])
      .range([innerHeight, 0]);

  var yAxis = d3.axisLeft()                       
      .scale(yScale);

  var bars = svg.append("g")
      .attr("id", "plot")                         
      .attr("transform", `translate (${margin.left+10}, ${margin.top})`)
      .selectAll("rect")
      .data(bardata);
  
  bars.enter().append("rect")
      .attr("x", (d, i) => xScale(i))
      .attr("y", d => yScale(d))
      .attr("width", xScale.bandwidth())
      .attr("height", d => innerHeight - yScale(d))
      .attr("fill", "#DBEDF3")
      .style("fill-opacity", .8);
  
  svg.append("g")                                  
      .attr("class", "yAxis")
      .attr("transform", `translate (${margin.left}, ${margin.top})`)
      .call(yAxis);
  
  var xAxis = d3.axisBottom()
      .scale(d3.scaleBand().domain(cat).range([0, innerWidth]).paddingInner(.3));
  
  svg.append("g")                                  
      .attr("class", "xAxis")
      .attr("transform", `translate (${margin.left+8}, ${innerHeight + margin.top})`)
      .call(xAxis);
}


});
</script>
<style type="text/css">
header {padding-top: 52px;}
#map {height: 95vh; width:100vw;}
footer {background-color: #808080; color: white; padding-top:0.5em;}
  
.SvgOverlay{position:relative;width:100%;height:100%}
.SvgOverlay svg{position:absolute;top:-4000px;left:-4000px;width:8000px;height:8000px}
.SvgOverlay path{stroke:#fff;stroke-width:1.5px}
.SvgOverlay path.food {fill: green; fill-opacity: .4;}
.SvgOverlay path.hotel {fill: blue; fill-opacity: .6;}
.SvgOverlay path:hover {fill-opacity: .8;}

#quake-pop-up{display:none;position:absolute;color:white;font-size:14px;background:rgba(0,0,0,.5);padding:5px 10px 5px 10px;-moz-border-radius:5px 5px;border-radius:5px 5px;z-index:99;right:0;top:60px}
#quake-pop-up-title{font-size:15px;width:100%;margin-bottom:4px;font-weight:bolder}
#quake-pop-up-content{font-size:14px}
#quake-pop-desc{margin-left:10px;color:white}

#myModal .modal-body section.row{padding: 1em;}
#myModal .modal-body section.row:hover{background-color: rgba(240, 255, 243, 1);}
</style>
</html>
